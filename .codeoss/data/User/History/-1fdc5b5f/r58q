from google.cloud import aiplatform
from google.cloud import storage
import os

# Initialize AI Platform
aiplatform.init(project="your-project-id", location="your-region")

# Define the RAG Corpus and the GCS Bucket
CORPUS_NAME = 'my_rag_corpus'
GCS_BUCKET = 'gs://rag-bucket-sandyaakevin-12345/'

# Initialize Cloud Storage Client
storage_client = storage.Client()

# Function to list files in the GCS bucket
def list_gcs_files():
    blobs = storage_client.list_blobs('rag-bucket-sandyaakevin-12345')
    for blob in blobs:
        print(f"File found: {blob.name}")

# Function to import files into RAG Corpus
def import_files():
    # Check if the corpus exists, or create it
    corpus = aiplatform.gapic.RagCorpusServiceClient()
    try:
        corpus.get_corpus(name=f"projects/{aiplatform.Project}.locations/us-central1.ragCorpora/{CORPUS_NAME}")
        print(f"Using existing corpus: {CORPUS_NAME}")
    except:
        print(f"Creating new corpus: {CORPUS_NAME}")
        corpus.create_corpus(name=f"projects/{aiplatform.Project}.locations/us-central1.ragCorpora/{CORPUS_NAME}")
    
    # Import files into the corpus
    for file in ['ch1.pdf', 'ch2.docx']:
        file_path = f"{GCS_BUCKET}{file}"
        print(f"Importing {file} into RAG Corpus...")
        corpus.import_files(gcs_source_uri=file_path)
        print(f"{file} imported successfully.")
    
    print("All files imported successfully.")
    list_gcs_files()

# Function to perform RAG Query
def run_rag_query():
    # Initialize the retrieval model
    rag_model = aiplatform.gapic.RagRetrievalModel()
    
    # Define the RAG Retrieval Config
    rag_retrieval_config = {
        'corpus_name': CORPUS_NAME,
        'query': 'summarize the content of ch1.pdf',
        'top_k_results': 3
    }
    
    # Run RAG retrieval
    response = rag_model.retrieve_documents(rag_retrieval_config)
    print("RAG Response:", response)
    print("Generated Response:", response['generated_response'])

# Main execution
if __name__ == '__main__':
    import_files()  # Import files to RAG corpus
    run_rag_query()  # Query the RAG model for document retrieval
